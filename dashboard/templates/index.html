<!DOCTYPE html>
<html>

<head>
    <title>Multi-Client SSE Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
        }

        .panel {
            flex: 1;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
        }

        .event {
            margin: 5px 0;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 3px;
            font-size: 12px;
        }

        .broadcast {
            background: #e6f3ff;
        }

        .direct {
            background: #ffe6e6;
        }

        .system {
            background: #e6ffe6;
        }

        .heartbeat {
            background: #f9f9f9;
            color: #999;
        }

        button {
            margin: 5px;
            padding: 8px 12px;
        }

        input,
        textarea {
            margin: 5px;
            padding: 5px;
            width: 200px;
        }

        #clientId {
            font-weight: bold;
            color: #007acc;
        }

        .stats {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <h1>Multi-Client SSE Test</h1>
    <div class="stats">
        <strong>Client ID:</strong> <span id="clientId">Not connected</span><br>
        <strong>Status:</strong> <span id="status">Disconnected</span><br>
        <strong>Messages Received:</strong> <span id="messageCount">0</span>
    </div>

    <div class="container">
        <div class="panel">
            <h3>Connection Control</h3>
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
            <button onclick="clearEvents()">Clear Events</button>

            <h3>Broadcast Message</h3>
            <input type="text" id="broadcastMsg" placeholder="Message to all clients">
            <button onclick="broadcastMessage()">Broadcast</button>

            <h3>Direct Message</h3>
            <input type="text" id="targetClient" placeholder="Target Client ID">
            <input type="text" id="directMsg" placeholder="Direct message">
            <button onclick="sendDirectMessage()">Send Direct</button>

            <button onclick="getClients()">Get Active Clients</button>
        </div>

        <div class="panel">
            <h3>Events <span id="eventCount"></span></h3>
            <div id="events" style="height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let clientId = null;
        let messageCount = 0;

        function connect() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/stream');

            eventSource.onopen = function (event) {
                document.getElementById('status').textContent = 'Connected';
                // Extract client ID from response headers when available
            };

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);
                messageCount++;
                document.getElementById('messageCount').textContent = messageCount;

                // Set client ID from the first message if not set
                if (!clientId && data.type === 'client_connected') {
                    clientId = event.target.url.split('?')[0]; // This is a workaround
                }

                addEvent(data);
            };

            eventSource.onerror = function (event) {
                document.getElementById('status').textContent = 'Error/Disconnected';
                console.error('SSE error:', event);
            };
        }

        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            document.getElementById('status').textContent = 'Disconnected';
        }

        function addEvent(data) {
            const eventsDiv = document.getElementById('events');
            const eventDiv = document.createElement('div');

            let className = 'event';
            let prefix = '';

            switch (data.type) {
                case 'broadcast':
                    className += ' broadcast';
                    prefix = '[BROADCAST] ';
                    break;
                case 'direct_message':
                    className += ' direct';
                    prefix = '[DIRECT] ';
                    break;
                case 'client_connected':
                case 'client_disconnected':
                case 'periodic_update':
                    className += ' system';
                    prefix = '[SYSTEM] ';
                    break;
                case 'heartbeat':
                    className += ' heartbeat';
                    prefix = '[HEARTBEAT] ';
                    break;
            }

            eventDiv.className = className;
            eventDiv.textContent = new Date().toLocaleTimeString() + ' - ' + prefix + JSON.stringify(data);
            eventsDiv.appendChild(eventDiv);
            eventsDiv.scrollTop = eventsDiv.scrollHeight;
        }

        function clearEvents() {
            document.getElementById('events').innerHTML = '';
            messageCount = 0;
            document.getElementById('messageCount').textContent = '0';
        }

        async function broadcastMessage() {
            const message = document.getElementById('broadcastMsg').value;
            if (!message) return;

            try {
                const response = await fetch('/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                const result = await response.json();
                console.log('Broadcast result:', result);
                document.getElementById('broadcastMsg').value = '';
            } catch (error) {
                console.error('Broadcast error:', error);
            }
        }

        async function sendDirectMessage() {
            const targetClient = document.getElementById('targetClient').value;
            const message = document.getElementById('directMsg').value;
            if (!targetClient || !message) return;

            try {
                const response = await fetch(`/send/${targetClient}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                const result = await response.json();
                console.log('Direct message result:', result);
                document.getElementById('directMsg').value = '';
            } catch (error) {
                console.error('Direct message error:', error);
            }
        }

        async function getClients() {
            try {
                const response = await fetch('/clients');
                const data = await response.json();
                console.log('Active clients:', data);
                alert(`Active clients: ${data.total_clients}\\n${JSON.stringify(data.clients, null, 2)}`);
            } catch (error) {
                console.error('Get clients error:', error);
            }
        }

        // Auto-connect on page load
        window.onload = function () {
            connect();
        };
    </script>
</body>
</html>